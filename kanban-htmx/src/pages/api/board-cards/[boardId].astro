---
import { getBoard, getUsers, createCard } from '../../../lib/api';
import BoardCardsResponse from '../../../components/BoardCardsResponse.astro';
import * as v from 'valibot';
import { CardSchema } from '../../../lib/validation';

const { boardId } = Astro.params;

if (!boardId) {
  Astro.response.status = 400;
  return new Response('Board ID required', { status: 400 });
}

const d1 = Astro.locals?.runtime?.env?.DB;

// Handle POST - create a new card
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const title = formData.get('title') as string;
    const description = formData.get('description') as string;
    const assigneeId = formData.get('assigneeId') as string;
    const tagIds = formData.getAll('tagIds') as string[];

    // Validate with Valibot
    const result = v.safeParse(CardSchema, {
      title,
      description: description || null,
      assigneeId: assigneeId || null,
      tagIds: tagIds.length > 0 ? tagIds : [],
    });

    if (!result.success) {
      Astro.response.status = 400;
      return new Response(result.issues[0].message, { status: 400 });
    }

    await createCard({
      boardId,
      ...result.output,
    }, d1);
  } catch (error) {
    console.error('Failed to create card:', error);
    Astro.response.status = 500;
    return new Response('Failed to create card', { status: 500 });
  }
}

// Get updated board and users
const board = await getBoard(boardId, d1);
const users = await getUsers(d1);

if (!board) {
  Astro.response.status = 404;
  return new Response('Board not found', { status: 404 });
}

---

<BoardCardsResponse board={board} users={users} />
