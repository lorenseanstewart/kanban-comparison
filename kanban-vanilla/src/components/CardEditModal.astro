---
import type { BoardDetails, UsersList, TagsList } from '../lib/api';

interface Props {
  board: BoardDetails;
  users: UsersList;
  tags: TagsList;
}

const { board, users, tags } = Astro.props;
---

<dialog id="edit-card-modal" class="modal">
  <div class="modal-box bg-base-200 dark:bg-base-300">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>

    <h3 class="font-bold text-lg mb-4">Edit Card</h3>

    <form
      id="edit-card-form"
      class="space-y-4"
      hx-patch=""
      hx-target="#board-cards-section"
      hx-swap="outerHTML"
      hx-on::after-request="window.kanbanApp.handleEditCardSuccess(event)"
    >
      <input type="hidden" id="edit-card-id" name="cardId" value="" />
      <input type="hidden" id="edit-board-id" name="boardId" value={board.id} />

      <div class="form-control w-full">
        <label class="label">
          <span class="label-text">Title</span>
        </label>
        <input
          type="text"
          id="edit-card-title"
          name="title"
          class="input input-bordered w-full"
          placeholder="Enter card title"
          required
        />
      </div>

      <div class="form-control w-full">
        <label class="label">
          <span class="label-text">Description</span>
        </label>
        <textarea
          id="edit-card-description"
          name="description"
          class="textarea textarea-bordered h-24 w-full"
          placeholder="Enter card description (optional)"
        ></textarea>
      </div>

      <div class="form-control w-full">
        <label class="label">
          <span class="label-text">Assignee</span>
        </label>
        <select id="edit-card-assignee" name="assigneeId" class="select select-bordered w-full">
          <option value="">Unassigned</option>
          {users.map((user) => (
            <option value={user.id}>{user.name}</option>
          ))}
        </select>
      </div>

      <div class="form-control w-full">
        <label class="label">
          <span class="label-text">Tags</span>
        </label>
        <div class="flex flex-wrap gap-2 p-4 border border-base-300 rounded-lg">
          {tags.map((tag) => (
            <label class="cursor-pointer">
              <input
                type="checkbox"
                name="tagIds"
                value={tag.id}
                class="hidden edit-tag-checkbox"
                data-edit-tag-id={tag.id}
              />
              <span
                class="badge border-2 font-semibold transition-all hover:scale-105 badge-outline"
                style={`color: ${tag.color}; border-color: ${tag.color};`}
                data-edit-tag-badge={tag.id}
              >
                {tag.name}
              </span>
            </label>
          ))}
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('edit-card-modal').close()">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          Save Changes
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script define:vars={{ board }}>
  // Global function to open edit modal
  window.openEditCardModal = (cardId) => {
    // Find the card in the board data
    let card = null;
    for (const list of board.lists) {
      const found = list.cards.find(c => c.id === cardId);
      if (found) {
        card = found;
        break;
      }
    }

    if (!card) return;

    // Set the hx-patch URL dynamically
    const form = document.getElementById('edit-card-form') as HTMLFormElement;
    form.setAttribute('hx-patch', `/api/card-update/${board.id}/${card.id}`);

    // Populate form
    document.getElementById('edit-card-id').value = card.id;
    document.getElementById('edit-card-title').value = card.title;
    document.getElementById('edit-card-description').value = card.description || '';
    document.getElementById('edit-card-assignee').value = card.assigneeId || '';

    // Reset and set tag checkboxes
    document.querySelectorAll('.edit-tag-checkbox').forEach(checkbox => {
      const input = checkbox as HTMLInputElement;
      const tagId = input.dataset.editTagId;
      const isSelected = card.tags.some(t => t.id === tagId);
      input.checked = isSelected;

      const badge = document.querySelector(`[data-edit-tag-badge="${tagId}"]`) as HTMLElement;
      if (isSelected) {
        badge.classList.remove('badge-outline');
        badge.classList.add('text-white');
        const bgColor = badge.style.color;
        badge.style.backgroundColor = bgColor;
      } else {
        badge.classList.add('badge-outline');
        badge.classList.remove('text-white');
        badge.style.backgroundColor = '';
      }
    });

    // Reinitialize HTMX for the form
    if (window.htmx) {
      window.htmx.process(form);
    }

    // Open modal
    document.getElementById('edit-card-modal').showModal();
  };

  // Initialize namespace if not exists
  window.kanbanApp = window.kanbanApp || {};

  // Handle success for card edit
  window.kanbanApp.handleEditCardSuccess = (event) => {
    if (event.detail.successful) {
      document.getElementById('edit-card-modal').close();
    }
  };

  // Handle tag selection
  document.querySelectorAll('.edit-tag-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const tagId = target.dataset.editTagId;
      const badge = document.querySelector(`[data-edit-tag-badge="${tagId}"]`) as HTMLElement;

      if (target.checked) {
        badge.classList.remove('badge-outline');
        badge.classList.add('text-white');
        const bgColor = badge.style.color;
        badge.style.backgroundColor = bgColor;
      } else {
        badge.classList.add('badge-outline');
        badge.classList.remove('text-white');
        badge.style.backgroundColor = '';
      }
    });
  });
</script>
